<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>model-preprocess â€¢ atlantistools</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="model-preprocess">
<meta property="og:description" content="atlantistools">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">atlantistools</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.4.3.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/model-calibration-species.html">model-calibration-species</a>
    </li>
    <li>
      <a href="../articles/model-calibration.html">model-calibration</a>
    </li>
    <li>
      <a href="../articles/model-comparison.html">model-comparison</a>
    </li>
    <li>
      <a href="../articles/model-preprocess.html">model-preprocess</a>
    </li>
    <li>
      <a href="../articles/package-demo.html">package-demo</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/alketh/atlantistools/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="model-preprocess_files/header-attrs-2.2/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>model-preprocess</h1>
                        <h4 class="author">Alexander Keth</h4>
            
            <h4 class="date">2020-10-05</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/alketh/atlantistools/blob/master/vignettes/model-preprocess.Rmd"><code>vignettes/model-preprocess.Rmd</code></a></small>
      <div class="hidden name"><code>model-preprocess.Rmd</code></div>

    </div>

    
    
<div id="motivation" class="section level2">
<h2 class="hasAnchor">
<a href="#motivation" class="anchor"></a>Motivation</h2>
<p>This Vignette is used to load in and preprocess autput from an Atlantis simulation. Given the complexity of the model output and the time it takes to process it the vignette has three main purposes 1. Standardise various output formats (netcdf, txt) and structures to a unified format. 2. Aggregate the complex Atlantis output in meaningul ways. E.g. horizontally and vertically. 3. Save the preprocessed output as a list of dataframes to save computation time and to make it easier to share model output.</p>
<p>Please feel free to modify the vignette to your likings by adding your personal calculation procedures. I will try to update this vignette as frequently as possible to make sure most functionality within atlantistools is present.</p>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st">"atlantistools"</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st">"ggplot2"</span>)</pre></body></html></div>
<pre><code>## Warning: package 'ggplot2' was built under R version 3.6.3</code></pre>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st">"gridExtra"</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st">"dplyr"</span>)</pre></body></html></div>
<pre><code>## Warning: package 'dplyr' was built under R version 3.6.3</code></pre>
<pre><code>## 
## Attaching package: 'dplyr'</code></pre>
<pre><code>## The following object is masked from 'package:gridExtra':
## 
##     combine</code></pre>
<pre><code>## The following object is masked from 'package:atlantistools':
## 
##     group_data</code></pre>
<pre><code>## The following objects are masked from 'package:stats':
## 
##     filter, lag</code></pre>
<pre><code>## The following objects are masked from 'package:base':
## 
##     intersect, setdiff, setequal, union</code></pre>
<div class="sourceCode" id="cb10"><html><body><pre class="r"># You should be able to build the vignette either by clicking on "Knit" in RStudio or with
# rmarkdown::render("model-preprocess.Rmd")</pre></body></html></div>
</div>
<div id="user-input" class="section level2">
<h2 class="hasAnchor">
<a href="#user-input" class="anchor"></a>User Input</h2>
<p>This section is used to define simulation specific variables. Please change this accordingly. I highly advice to set the Atlantis directory as working directory in your R session. In addition you should try to work within a R project. By doing so there is no need to create the connections to the model files with calls to <code><a href="https://rdrr.io/r/base/file.path.html">file.path()</a></code>. You can simply pass the names of the files as arguments. Please make sure to add subdirectories in case you use different folders for input- and output model files.</p>
<div class="sourceCode" id="cb11"><html><body><pre class="r"><span class="no">d</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span>(<span class="st">"extdata"</span>, <span class="st">"setas-model-new-trunk"</span>, <span class="kw">package</span> <span class="kw">=</span> <span class="st">"atlantistools"</span>)

<span class="no">nc_gen</span>    <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="no">d</span>, <span class="st">"outputSETAS.nc"</span>)
<span class="no">nc_prod</span>   <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="no">d</span>, <span class="st">"outputSETASPROD.nc"</span>)
<span class="no">dietcheck</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="no">d</span>, <span class="st">"outputSETASDietCheck.txt"</span>)
<span class="no">yoy</span>       <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="no">d</span>, <span class="st">"outputSETASYOY.txt"</span>)
<span class="no">ssb</span>       <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="no">d</span>, <span class="st">"outputSETASSSB.txt"</span>)
<span class="no">prm_run</span>   <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="no">d</span>, <span class="st">"VMPA_setas_run_fishing_F_Trunk.prm"</span>)
<span class="no">prm_biol</span>  <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="no">d</span>, <span class="st">"VMPA_setas_biol_fishing_Trunk.prm"</span>)
<span class="no">fgs</span>       <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="no">d</span>, <span class="st">"SETasGroupsDem_NoCep.csv"</span>)
<span class="no">bgm</span>       <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="no">d</span>, <span class="st">"VMPA_setas.bgm"</span>)
<span class="no">init</span>      <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="no">d</span>, <span class="st">"INIT_VMPA_Jan2015.nc"</span>)</pre></body></html></div>
</div>
<div id="define-additional-variables-using-build-in-atlantistools-functions-" class="section level2">
<h2 class="hasAnchor">
<a href="#define-additional-variables-using-build-in-atlantistools-functions-" class="anchor"></a>Define additional variables using build in atlantistools functions.</h2>
<div class="sourceCode" id="cb12"><html><body><pre class="r"><span class="no">bboxes</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/get_boundary.html">get_boundary</a></span>(<span class="kw">boxinfo</span> <span class="kw">=</span> <span class="fu"><a href="../reference/load_box.html">load_box</a></span>(<span class="no">bgm</span>))
<span class="no">bps</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/load_bps.html">load_bps</a></span>(<span class="no">fgs</span>, <span class="no">init</span>)
<span class="no">bio_conv</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/get_conv_mgnbiot.html">get_conv_mgnbiot</a></span>(<span class="no">prm_biol</span>)

<span class="co"># By default data from all groups within the simulation is extracted!</span>
<span class="no">groups</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/get_groups.html">get_groups</a></span>(<span class="no">fgs</span>)
<span class="no">groups_age</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/get_groups.html">get_age_groups</a></span>(<span class="no">fgs</span>)
<span class="no">groups_rest</span> <span class="kw">&lt;-</span> <span class="no">groups</span>[!<span class="no">groups</span> <span class="kw">%in%</span> <span class="no">groups_age</span>]</pre></body></html></div>
</div>
<div id="read-in-data-from-atlantis-simulation-" class="section level2">
<h2 class="hasAnchor">
<a href="#read-in-data-from-atlantis-simulation-" class="anchor"></a>Read in data from Atlantis simulation.</h2>
<div class="sourceCode" id="cb13"><html><body><pre class="r"><span class="co"># Read in raw untransformed data from nc_gen</span>
<span class="no">vars</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="st">"Nums"</span>, <span class="st">"StructN"</span>, <span class="st">"ResN"</span>, <span class="st">"N"</span>)
<span class="no">grps</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="no">groups_age</span>, <span class="no">groups_age</span>, <span class="no">groups_age</span>, <span class="no">groups_rest</span>)
<span class="no">dfs_gen</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/funprog.html">Map</a></span>(<span class="no">load_nc</span>, <span class="kw">select_variable</span> <span class="kw">=</span> <span class="no">vars</span>, <span class="kw">select_groups</span> <span class="kw">=</span> <span class="no">grps</span>,
               <span class="kw">MoreArgs</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">nc</span> <span class="kw">=</span> <span class="no">nc_gen</span>, <span class="kw">bps</span> <span class="kw">=</span> <span class="no">bps</span>, <span class="kw">fgs</span> <span class="kw">=</span> <span class="no">fgs</span>, <span class="kw">prm_run</span> <span class="kw">=</span> <span class="no">prm_run</span>, <span class="kw">bboxes</span> <span class="kw">=</span> <span class="no">bboxes</span>))

<span class="co"># Read in raw untransformed data from nc_prod</span>
<span class="no">vars</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="st">"Eat"</span>, <span class="st">"Grazing"</span>, <span class="st">"Growth"</span>)
<span class="no">grps</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="no">groups_age</span>, <span class="no">groups_rest</span>, <span class="no">groups_age</span>)
<span class="no">dfs_prod</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/funprog.html">Map</a></span>(<span class="no">load_nc</span>, <span class="kw">select_variable</span> <span class="kw">=</span> <span class="no">vars</span>, <span class="kw">select_groups</span> <span class="kw">=</span> <span class="no">grps</span>,
                <span class="kw">MoreArgs</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">nc</span> <span class="kw">=</span> <span class="no">nc_prod</span>, <span class="kw">bps</span> <span class="kw">=</span> <span class="no">bps</span>, <span class="kw">fgs</span> <span class="kw">=</span> <span class="no">fgs</span>, <span class="kw">prm_run</span> <span class="kw">=</span> <span class="no">prm_run</span>, <span class="kw">bboxes</span> <span class="kw">=</span> <span class="no">bboxes</span>))

<span class="co"># Read in physics</span>
<span class="no">flux</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/load_nc_physics.html">load_nc_physics</a></span>(<span class="kw">nc</span> <span class="kw">=</span> <span class="no">nc_gen</span>, <span class="kw">select_physics</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"eflux"</span>, <span class="st">"vflux"</span>),
                        <span class="kw">prm_run</span> <span class="kw">=</span> <span class="no">prm_run</span>, <span class="kw">bboxes</span> <span class="kw">=</span> <span class="no">bboxes</span>)

<span class="no">sink</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/load_nc_physics.html">load_nc_physics</a></span>(<span class="kw">nc</span> <span class="kw">=</span> <span class="no">nc_gen</span>, <span class="kw">select_physics</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"hdsource"</span>, <span class="st">"hdsink"</span>),
                        <span class="kw">prm_run</span> <span class="kw">=</span> <span class="no">prm_run</span>, <span class="kw">bboxes</span> <span class="kw">=</span> <span class="no">bboxes</span>)

<span class="no">physics</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/load_nc_physics.html">load_nc_physics</a></span>(<span class="kw">nc</span> <span class="kw">=</span> <span class="no">nc_gen</span>,
                           <span class="kw">select_physics</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"salt"</span>, <span class="st">"NO3"</span>, <span class="st">"NH3"</span>, <span class="st">"Temp"</span>, <span class="st">"Chl_a"</span>, <span class="st">"Denitrifiction"</span>),
                           <span class="kw">prm_run</span> <span class="kw">=</span> <span class="no">prm_run</span>, <span class="kw">bboxes</span> <span class="kw">=</span> <span class="no">bboxes</span>)

<span class="co"># exclude sediment layer from salinity</span>
<span class="no">physics</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(<span class="no">physics</span>, !(<span class="no">variable</span> <span class="kw">==</span> <span class="st">"salt"</span> <span class="kw">&amp;</span> <span class="no">layer</span> <span class="kw">==</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="no">layer</span>) <span class="kw">&amp;</span> <span class="no">time</span> <span class="kw">==</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span>(<span class="no">time</span>)))
<span class="co"># exlucde water column from Denitrifiction</span>
<span class="no">physics</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(<span class="no">physics</span>, !(<span class="no">variable</span> <span class="kw">==</span> <span class="st">"Denitrifiction"</span> <span class="kw">&amp;</span> <span class="no">layer</span> <span class="kw">!=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="no">layer</span>) <span class="kw">&amp;</span> <span class="no">time</span> <span class="kw">==</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span>(<span class="no">time</span>)))

<span class="no">vol_dz</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/load_nc_physics.html">load_nc_physics</a></span>(<span class="kw">nc</span> <span class="kw">=</span> <span class="no">nc_gen</span>, <span class="kw">select_physics</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"volume"</span>, <span class="st">"dz"</span>),
                          <span class="kw">prm_run</span> <span class="kw">=</span> <span class="no">prm_run</span>, <span class="kw">bboxes</span> <span class="kw">=</span> <span class="no">bboxes</span>)

<span class="no">dz</span> <span class="kw">&lt;-</span> <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(<span class="no">vol_dz</span>, <span class="no">variable</span> <span class="kw">==</span> <span class="st">"dz"</span>)
<span class="no">vol</span> <span class="kw">&lt;-</span> <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(<span class="no">vol_dz</span>, <span class="no">variable</span> <span class="kw">==</span> <span class="st">"volume"</span>)

<span class="no">nominal_dz</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/load_init.html">load_init</a></span>(<span class="kw">init</span> <span class="kw">=</span> <span class="no">init</span>, <span class="kw">vars</span> <span class="kw">=</span> <span class="st">"nominal_dz"</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span>() <span class="kw">%&gt;%</span>
  <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(!<span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="no">layer</span>))

<span class="co"># Read in Dietcheck</span>
<span class="no">df_dm</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/load_dietcheck.html">load_dietcheck</a></span>(<span class="kw">dietcheck</span> <span class="kw">=</span> <span class="no">dietcheck</span>,
                        <span class="kw">fgs</span> <span class="kw">=</span> <span class="no">fgs</span>, <span class="kw">prm_run</span> <span class="kw">=</span> <span class="no">prm_run</span>, <span class="kw">convert_names</span> <span class="kw">=</span> <span class="fl">TRUE</span>)

<span class="co"># Read in SSB/R</span>
<span class="no">ssb_rec</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/load_rec.html">load_rec</a></span>(<span class="kw">yoy</span> <span class="kw">=</span> <span class="no">yoy</span>, <span class="kw">ssb</span> <span class="kw">=</span> <span class="no">ssb</span>, <span class="kw">prm_biol</span> <span class="kw">=</span> <span class="no">prm_biol</span>)

<span class="co"># Read in misc  </span>
<span class="no">df_agemat</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/prm_to_df.html">prm_to_df</a></span>(<span class="kw">prm_biol</span> <span class="kw">=</span> <span class="no">prm_biol</span>, <span class="kw">fgs</span> <span class="kw">=</span> <span class="no">fgs</span>, <span class="kw">group</span> <span class="kw">=</span> <span class="fu"><a href="../reference/get_groups.html">get_age_acronyms</a></span>(<span class="no">fgs</span>), <span class="kw">parameter</span> <span class="kw">=</span> <span class="st">"age_mat"</span>)
<span class="no">dietmatrix</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/load_dietmatrix.html">load_dietmatrix</a></span>(<span class="no">prm_biol</span>, <span class="no">fgs</span>, <span class="kw">convert_names</span> <span class="kw">=</span> <span class="fl">TRUE</span>)</pre></body></html></div>
<pre><code>## `.cols` has been renamed and is deprecated, please use `.vars`</code></pre>
</div>
<div id="apply-preprocess-calculations" class="section level2">
<h2 class="hasAnchor">
<a href="#apply-preprocess-calculations" class="anchor"></a>Apply preprocess calculations</h2>
<div class="sourceCode" id="cb15"><html><body><pre class="r"><span class="co"># Calculate biomass spatially</span>
<span class="no">bio_sp</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/calculate_biomass_spatial.html">calculate_biomass_spatial</a></span>(<span class="kw">nums</span> <span class="kw">=</span> <span class="no">dfs_gen</span><span class="kw">[[</span><span class="fl">1</span>]], <span class="kw">sn</span> <span class="kw">=</span> <span class="no">dfs_gen</span><span class="kw">[[</span><span class="fl">2</span>]], <span class="kw">rn</span> <span class="kw">=</span> <span class="no">dfs_gen</span><span class="kw">[[</span><span class="fl">3</span>]], <span class="kw">n</span> <span class="kw">=</span> <span class="no">dfs_gen</span><span class="kw">[[</span><span class="fl">4</span>]],
                                    <span class="kw">vol_dz</span> <span class="kw">=</span> <span class="no">vol_dz</span>, <span class="kw">bio_conv</span> <span class="kw">=</span> <span class="no">bio_conv</span>, <span class="kw">bps</span> <span class="kw">=</span> <span class="no">bps</span>)

<span class="co"># Aggregate spatial biomass to based on stanzas</span>
<span class="no">bio_sp_stanza</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/combine_ages.html">combine_ages</a></span>(<span class="no">bio_sp</span>, <span class="kw">grp_col</span> <span class="kw">=</span> <span class="st">"species"</span>, <span class="kw">agemat</span> <span class="kw">=</span> <span class="no">df_agemat</span>)</pre></body></html></div>
<pre><code>## Joining, by = "species"</code></pre>
<div class="sourceCode" id="cb17"><html><body><pre class="r"><span class="co"># Aggregate biomass</span>
<span class="no">biomass</span> <span class="kw">&lt;-</span> <span class="no">bio_sp</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="../reference/agg_data.html">agg_data</a></span>(<span class="kw">groups</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"species"</span>, <span class="st">"time"</span>), <span class="kw">fun</span> <span class="kw">=</span> <span class="no">sum</span>)

<span class="no">biomass_age</span> <span class="kw">&lt;-</span> <span class="no">bio_sp</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(<span class="no">agecl</span> <span class="kw">&gt;</span> <span class="fl">2</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="../reference/agg_data.html">agg_data</a></span>(<span class="kw">groups</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"species"</span>, <span class="st">"agecl"</span>, <span class="st">"time"</span>), <span class="kw">fun</span> <span class="kw">=</span> <span class="no">sum</span>)

<span class="co"># Aggregate Numbers! This is done seperately since numbers need to be summed!</span>
<span class="no">nums</span>     <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/agg_data.html">agg_data</a></span>(<span class="kw">data</span> <span class="kw">=</span> <span class="no">dfs_gen</span><span class="kw">[[</span><span class="fl">1</span>]], <span class="kw">groups</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"species"</span>, <span class="st">"time"</span>), <span class="kw">fun</span> <span class="kw">=</span> <span class="no">sum</span>)
<span class="no">nums_age</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/agg_data.html">agg_data</a></span>(<span class="kw">data</span> <span class="kw">=</span> <span class="no">dfs_gen</span><span class="kw">[[</span><span class="fl">1</span>]], <span class="kw">groups</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"species"</span>, <span class="st">"agecl"</span>, <span class="st">"time"</span>), <span class="kw">fun</span> <span class="kw">=</span> <span class="no">sum</span>)
<span class="no">nums_box</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/agg_data.html">agg_data</a></span>(<span class="kw">data</span> <span class="kw">=</span> <span class="no">dfs_gen</span><span class="kw">[[</span><span class="fl">1</span>]], <span class="kw">groups</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"species"</span>, <span class="st">"polygon"</span>, <span class="st">"time"</span>), <span class="kw">fun</span> <span class="kw">=</span> <span class="no">sum</span>)

<span class="co"># Aggregate the rest of the dataframes by mean!</span>
<span class="no">structn_age</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/agg_data.html">agg_data</a></span>(<span class="kw">data</span> <span class="kw">=</span> <span class="no">dfs_gen</span><span class="kw">[[</span><span class="fl">2</span>]],  <span class="kw">groups</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"species"</span>, <span class="st">"time"</span>, <span class="st">"agecl"</span>), <span class="kw">fun</span> <span class="kw">=</span> <span class="no">mean</span>)
<span class="no">resn_age</span>    <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/agg_data.html">agg_data</a></span>(<span class="kw">data</span> <span class="kw">=</span> <span class="no">dfs_gen</span><span class="kw">[[</span><span class="fl">3</span>]],  <span class="kw">groups</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"species"</span>, <span class="st">"time"</span>, <span class="st">"agecl"</span>), <span class="kw">fun</span> <span class="kw">=</span> <span class="no">mean</span>)
<span class="no">eat_age</span>     <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/agg_data.html">agg_data</a></span>(<span class="kw">data</span> <span class="kw">=</span> <span class="no">dfs_prod</span><span class="kw">[[</span><span class="fl">1</span>]], <span class="kw">groups</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"species"</span>, <span class="st">"time"</span>, <span class="st">"agecl"</span>), <span class="kw">fun</span> <span class="kw">=</span> <span class="no">mean</span>)
<span class="no">grazing</span>     <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/agg_data.html">agg_data</a></span>(<span class="kw">data</span> <span class="kw">=</span> <span class="no">dfs_prod</span><span class="kw">[[</span><span class="fl">2</span>]], <span class="kw">groups</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"species"</span>, <span class="st">"time"</span>), <span class="kw">fun</span> <span class="kw">=</span> <span class="no">mean</span>)
<span class="no">growth_age</span>  <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/agg_data.html">agg_data</a></span>(<span class="kw">data</span> <span class="kw">=</span> <span class="no">dfs_prod</span><span class="kw">[[</span><span class="fl">3</span>]], <span class="kw">groups</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"species"</span>, <span class="st">"time"</span>, <span class="st">"agecl"</span>), <span class="kw">fun</span> <span class="kw">=</span> <span class="no">mean</span>)

<span class="co"># Calculate consumed biomass</span>
<span class="no">bio_cons</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/calculate_consumed_biomass.html">calculate_consumed_biomass</a></span>(<span class="kw">eat</span> <span class="kw">=</span> <span class="no">dfs_prod</span><span class="kw">[[</span><span class="fl">1</span>]], <span class="kw">grazing</span> <span class="kw">=</span> <span class="no">dfs_prod</span><span class="kw">[[</span><span class="fl">2</span>]], <span class="kw">dm</span> <span class="kw">=</span> <span class="no">df_dm</span>,
                                       <span class="kw">vol</span> <span class="kw">=</span> <span class="no">vol</span>, <span class="kw">bio_conv</span> <span class="kw">=</span> <span class="no">bio_conv</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="../reference/agg_data.html">agg_data</a></span>(<span class="kw">groups</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"pred"</span>, <span class="st">"agecl"</span>, <span class="st">"time"</span>, <span class="st">"prey"</span>), <span class="kw">fun</span> <span class="kw">=</span> <span class="no">sum</span>)</pre></body></html></div>
<pre><code>## 50% matching timesteps between PROD.nc and DietCheck.txt</code></pre>
<pre><code>## 11.61% data is lost due to missing diet data despite available eat data.</code></pre>
<pre><code>## 21.97% data is lost due to missing eat data despite available diet data.</code></pre>
<div class="sourceCode" id="cb21"><html><body><pre class="r"><span class="co"># Calculate spatial overlap</span>
<span class="no">sp_overlap</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/calculate_spatial_overlap.html">calculate_spatial_overlap</a></span>(<span class="kw">biomass_spatial</span> <span class="kw">=</span> <span class="no">bio_sp</span>, <span class="kw">dietmatrix</span> <span class="kw">=</span> <span class="no">dietmatrix</span>, <span class="kw">agemat</span> <span class="kw">=</span> <span class="no">df_agemat</span>)

<span class="co"># Growth relative to initial conditions</span>
<span class="no">rec_weight</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/prm_to_df.html">prm_to_df</a></span>(<span class="kw">prm_biol</span> <span class="kw">=</span> <span class="no">prm_biol</span>, <span class="kw">fgs</span> <span class="kw">=</span> <span class="no">fgs</span>,
                        <span class="kw">group</span> <span class="kw">=</span> <span class="fu"><a href="../reference/get_groups.html">get_age_acronyms</a></span>(<span class="kw">fgs</span> <span class="kw">=</span> <span class="no">fgs</span>),
                        <span class="kw">parameter</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"KWRR"</span>, <span class="st">"KWSR"</span>, <span class="st">"AgeClassSize"</span>))

<span class="no">pd</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/load_init_age.html">load_init_weight</a></span>(<span class="kw">init</span> <span class="kw">=</span> <span class="no">init</span>, <span class="kw">fgs</span> <span class="kw">=</span> <span class="no">fgs</span>, <span class="kw">bboxes</span> <span class="kw">=</span> <span class="no">bboxes</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join.html">left_join</a></span>(<span class="no">rec_weight</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/split.html">split</a></span>(<span class="no">.</span>$<span class="no">species</span>)</pre></body></html></div>
<pre><code>## Joining, by = "species"</code></pre>
<div class="sourceCode" id="cb23"><html><body><pre class="r"><span class="co"># Calculate weight difference from one ageclass to the next!</span>
<span class="kw">for</span> (<span class="no">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span>(<span class="no">pd</span>)) {
  <span class="no">pd</span><span class="kw">[[</span><span class="no">i</span>]]$<span class="no">wdiff</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>((<span class="no">pd</span><span class="kw">[[</span><span class="no">i</span>]]$<span class="no">rn</span>[<span class="fl">1</span>] + <span class="no">pd</span><span class="kw">[[</span><span class="no">i</span>]]$<span class="no">sn</span>[<span class="fl">1</span>]) - (<span class="no">pd</span><span class="kw">[[</span><span class="no">i</span>]]$<span class="no">kwrr</span>[<span class="fl">1</span>] + <span class="no">pd</span><span class="kw">[[</span><span class="no">i</span>]]$<span class="no">kwsr</span>[<span class="fl">1</span>]),
                     <span class="fu"><a href="https://rdrr.io/r/base/diff.html">diff</a></span>(<span class="no">pd</span><span class="kw">[[</span><span class="no">i</span>]]$<span class="no">rn</span> + <span class="no">pd</span><span class="kw">[[</span><span class="no">i</span>]]$<span class="no">sn</span>))
}
<span class="no">pd</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span>(<span class="no">rbind</span>, <span class="no">pd</span>)
<span class="no">pd</span>$<span class="no">growth_req</span> <span class="kw">&lt;-</span> <span class="no">pd</span>$<span class="no">wdiff</span> / (<span class="fl">365</span> * <span class="no">pd</span>$<span class="no">ageclasssize</span>)
<span class="kw">if</span> (<span class="fu"><a href="https://rdrr.io/r/base/any.html">any</a></span>(<span class="no">pd</span>$<span class="no">growth_req</span> <span class="kw">&lt;</span> <span class="fl">0</span>)) {
  <span class="fu"><a href="https://rdrr.io/r/base/warning.html">warning</a></span>(<span class="st">"Required growth negative for some groups. Please check your initial conditions files."</span>)
}

<span class="no">gr_req</span> <span class="kw">&lt;-</span> <span class="no">pd</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(<span class="no">species</span>, <span class="no">agecl</span>, <span class="no">growth_req</span>)

<span class="no">gr_rel_init</span> <span class="kw">&lt;-</span> <span class="no">growth_age</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join.html">left_join</a></span>(<span class="no">gr_req</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="kw">gr_rel</span> <span class="kw">=</span> (<span class="no">atoutput</span> - <span class="no">growth_req</span>) / <span class="no">growth_req</span>)</pre></body></html></div>
<pre><code>## Joining, by = c("species", "agecl")</code></pre>
<div class="sourceCode" id="cb25"><html><body><pre class="r"><span class="co"># Aggregate volume vertically.</span>
<span class="no">vol_ts</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/agg_data.html">agg_data</a></span>(<span class="no">vol</span>, <span class="kw">groups</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"time"</span>, <span class="st">"polygon"</span>), <span class="kw">fun</span> <span class="kw">=</span> <span class="no">sum</span>, <span class="kw">out</span> <span class="kw">=</span> <span class="st">"volume"</span>)</pre></body></html></div>
</div>
<div id="combine-objects-to-a-list-of-preprocessed-dataframes-" class="section level2">
<h2 class="hasAnchor">
<a href="#combine-objects-to-a-list-of-preprocessed-dataframes-" class="anchor"></a>Combine objects to a list of preprocessed dataframes.</h2>
<div class="sourceCode" id="cb26"><html><body><pre class="r">  <span class="no">result</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(
    <span class="st">"biomass"</span>                <span class="kw">=</span> <span class="no">biomass</span>,       <span class="co">#1</span>
    <span class="st">"biomass_age"</span>            <span class="kw">=</span> <span class="no">biomass_age</span>,
    <span class="st">"biomass_consumed"</span>       <span class="kw">=</span> <span class="no">bio_cons</span>,
    <span class="st">"biomass_spatial_stanza"</span> <span class="kw">=</span> <span class="no">bio_sp_stanza</span>,
    <span class="st">"diet"</span>                   <span class="kw">=</span> <span class="no">df_dm</span>,         <span class="co">#5 </span>
    <span class="st">"dz"</span>                     <span class="kw">=</span> <span class="no">dz</span>,
    <span class="st">"eat_age"</span>                <span class="kw">=</span> <span class="no">eat_age</span>,
    <span class="st">"flux"</span>                   <span class="kw">=</span> <span class="no">flux</span>,
    <span class="st">"grazing"</span>                <span class="kw">=</span> <span class="no">grazing</span>,
    <span class="st">"growth_age"</span>             <span class="kw">=</span> <span class="no">growth_age</span>,    <span class="co">#10</span>
    <span class="st">"growth_rel_init"</span>        <span class="kw">=</span> <span class="no">gr_rel_init</span>,
    <span class="st">"nominal_dz"</span>             <span class="kw">=</span> <span class="no">nominal_dz</span>,
    <span class="st">"nums"</span>                   <span class="kw">=</span> <span class="no">nums</span>,
    <span class="st">"nums_age"</span>               <span class="kw">=</span> <span class="no">nums_age</span>,
    <span class="st">"nums_box"</span>               <span class="kw">=</span> <span class="no">nums_box</span>,      <span class="co">#15</span>
    <span class="st">"physics"</span>                <span class="kw">=</span> <span class="no">physics</span>,
    <span class="st">"resn_age"</span>               <span class="kw">=</span> <span class="no">resn_age</span>,
    <span class="st">"sink"</span>                   <span class="kw">=</span> <span class="no">sink</span>,
    <span class="st">"spatial_overlap"</span>        <span class="kw">=</span> <span class="no">sp_overlap</span>,
    <span class="st">"ssb_rec"</span>                <span class="kw">=</span> <span class="no">ssb_rec</span>,       <span class="co">#20</span>
    <span class="st">"structn_age"</span>            <span class="kw">=</span> <span class="no">structn_age</span>,
    <span class="st">"vol"</span>                    <span class="kw">=</span> <span class="no">vol_ts</span>
  )</pre></body></html></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Alexander Keth.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
